<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>For My Love ❤</title>
  <meta name="description" content="Love page for my girl.">
  <style>
    :root{
      --bg:#000;            /* 全黑背景 */
      --heart:#ff3b7a;
      --halo:#ffa4c2;
      --text:#fff;
      --maxw: 720px;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif
    }
    a{color:#ff8fb1}
    .wrap{
      min-height:100vh;display:flex;align-items:center;justify-content:center;
      position:relative;padding:14px
    }
    canvas{
      display:block;width:min(92vw,var(--maxw));
      height:calc(min(92vw,var(--maxw))*1.12);max-width:var(--maxw);
      border-radius:18px;box-shadow:0 16px 44px rgba(0,0,0,.6);background:var(--bg)
    }
    .overlay-text{
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:max(14px, env(safe-area-inset-bottom, 14px));
      width:min(92vw,var(--maxw));text-align:center;line-height:1.7;
      padding:8px 14px;font-size:clamp(14px,2.7vw,18px);
      text-shadow:0 2px 4px rgba(0,0,0,.6);pointer-events:none
    }
    .overlay-text b{font-weight:700}
    .scroll-down{
      position:absolute;top:10px;left:50%;transform:translateX(-50%);
      font-size:13px;opacity:.7;pointer-events:auto
    }

    /* 手写信区域 */
    .letter{
      padding:42px 16px 64px;display:flex;flex-direction:column;align-items:center;gap:12px
    }
    .letter h2{margin:0 0 6px 0;font-size:18px;font-weight:600;opacity:.9}
    .letter .tip{font-size:12px;opacity:.6;margin-bottom:8px}
    .letter .img-wrap{
      width:min(92vw,var(--maxw));max-width:var(--maxw);
      border-radius:14px;overflow:hidden;box-shadow:0 14px 40px rgba(0,0,0,.65);
      background:#111;padding:0
    }
    .letter img{
      display:block;width:100%;height:auto;vertical-align:middle;
      image-rendering:auto;
    }
    .footer{padding:18px 0 48px;text-align:center;font-size:12px;opacity:.45}
  </style>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%92%96%3C/text%3E%3C/svg%3E">
</head>
<body>

<!-- ======== 配置区：按需修改 ======== -->
<script>
  const START_DATE = "2022-12-06";          // 在一起日期（YYYY-MM-DD）
  const HER_NAME   = "Baby";                 // 称呼
  const TIMEZONE   = "Asia/Kuala_Lumpur";    // 计时/展示时区
  const LETTER_SRC = "letter.jpg";    // 手写信图片路径（放仓库里）
</script>
<!-- ================================= -->

<!-- 爱心动画区 -->
<section class="wrap">
  <a class="scroll-down" href="#letter">👇 向下看你的手写信</a>
  <canvas id="cv" width="640" height="720"></canvas>
  <div class="overlay-text" id="loveText"></div>
</section>

<!-- 手写信区 -->
<section id="letter" class="letter">
  <h2>给你的一封手写信</h2>
  <div class="tip">（点图片可放大）</div>
  <a class="img-wrap" target="_blank" rel="noopener" href="" id="letterLink">
    <img id="letterImg" src="" alt="手写情书图片" loading="lazy" />
  </a>
</section>

<div class="footer">made with ❤</div>

<script>
/* ======= 文案 & 计时 ======= */
function daysTogether(startStr, tz){
  const [y,m,d]=startStr.split("-").map(Number);
  const todayStr=new Intl.DateTimeFormat('sv-SE',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());
  const today=new Date(`${todayStr}T00:00:00`);
  const start=new Date(`${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T00:00:00`);
  return Math.floor((today-start)/86400000)+1;
}
function yearsTogether(startStr,tz){
  const [y,m,d]=startStr.split("-").map(Number);
  const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
  let yrs=now.getFullYear()-y;
  const anniv=new Date(now.getFullYear(),m-1,d);
  if(now<anniv) yrs-=1;
  return Math.max(0,yrs);
}
function renderText(){
  const d=daysTogether(START_DATE,TIMEZONE);
  const y=yearsTogether(START_DATE,TIMEZONE);
  const todayFmt=new Intl.DateTimeFormat('zh-CN',{timeZone:TIMEZONE,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());
  const line1=`${HER_NAME}，纪念日快乐！`;
  const line2=`今天是我们在一起的第 <b>${d}</b> 天 ❤️` + (y>0?`，也是第 <b>${y}</b> 周年 🎉`:"");
  const line3=`—— ${todayFmt}`;
  document.getElementById("loveText").innerHTML=`${line1}<br>${line2}<br>${line3}`;
  // 手写信图片
  const img=document.getElementById('letterImg');
  const link=document.getElementById('letterLink');
  img.src=LETTER_SRC; link.href=LETTER_SRC;
}
renderText();

/* ======= 爱心粒子动画（黑底）— 修正版 ======= */
const BG = "#000";
const HEART = getComputedStyle(document.documentElement).getPropertyValue('--heart').trim() || "#ff3b7a";
const HALO  = getComputedStyle(document.documentElement).getPropertyValue('--halo').trim()  || "#ffa4c2";

/* 性能参数：FPS 降一点更稳，QUALITY 可按设备调（0.5~1.2） */
const FPS = 30;
const QUALITY = window.matchMedia('(max-width: 480px)').matches ? 0.65 : 0.85; // 手机略降复杂度

function heartXY(t, shrink=10){
  let x = 16 * Math.sin(t)**2 * Math.sin(t); // = 16*sin^3(t)
  let y = 13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t);
  x/=16; y/=18;
  return [x/shrink, -y/shrink];
}
const rand=(a,b)=>a+Math.random()*(b-a);
const choice=a=>a[(Math.random()*a.length)|0];
const clamp01=x=>Math.min(1, Math.max(0, x));
function shrink(x,y,r){return [x*r,y*r];}
function scatterInside(x,y,b=0.07){const r=-b*Math.log(Math.random()+1e-9);return [x-r*(x-0), y-r*(y-0)];}
function ease01(x){return (1 - Math.cos(clamp01(x)*Math.PI))/2;}
function S(n){ return Math.max(1, Math.round(n * QUALITY)); }

function genFrame(frame, total){
  // 关键修复：避免 ratio==0，给一个很小的起始值
  const ratio = 0.2 + 9.8 * ease01(frame/total);

  const pts = [];

  // halo：固定次数采样，避免死循环
  const haloN = S(1200 + 800 * Math.abs(ease01(frame/total)**2));
  for (let i=0; i<haloN; i++){
    const t = rand(0, Math.PI*2);
    let [x,y] = heartXY(t, 11.0);
    [x,y] = shrink(x,y, ratio/11.0);
    const size = (Math.random() < 0.5) ? 1 : 2;
    pts.push({x,y,s:size,h:true});
  }

  // 主边缘
  const edge = [];
  for (let i=0; i<S(250); i++){
    const t = rand(0, Math.PI*2);
    edge.push(heartXY(t, 1.0));
  }

  // 扩散边缘
  for (const [ex,ey] of edge){
    let [x,y] = scatterInside(ex,ey,0.05);
    pts.push({x:x/ratio, y:y/ratio, s:1+(Math.random()*2|0), h:false});
  }

  // 内部
  for (let i=0; i<S(2000); i++){
    const [ex,ey] = choice(edge);
    let [x,y] = scatterInside(ex,ey,0.17);
    pts.push({x:x/ratio, y:y/ratio, s:1+(Math.random()*2|0), h:false});
  }

  return pts;
}

(function start(){
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");
  const W = cv.width, H = cv.height;
  let frame = 0;
  const total = 6 * FPS; // 6秒循环

  function draw(){
    ctx.fillStyle = BG;
    ctx.fillRect(0,0,W,H);

    const ps = genFrame(frame, total);
    const cx = W/2, cy = H/2 - 30;
    const scale = W * 0.85;

    // 先画 halo 再画主体，层次更好
    for (let i=0; i<ps.length; i++){
      const p = ps[i];
      const X = (cx + p.x*scale) | 0;
      const Y = (cy + p.y*scale) | 0;
      ctx.fillStyle = p.h ? HALO : HEART;
      ctx.fillRect(X, Y, p.s, p.s);
    }

    frame = (frame + 1) % total;
  }

  // 帧率控制
  let last=0, acc=0, interval = 1000 / FPS;
  function loop(ts){
    if (!last) last = ts;
    const d = ts - last;
    last = ts;
    acc += d;
    while (acc >= interval){
      draw();
      acc -= interval;
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
