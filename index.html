<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>For My Love â¤</title>
  <meta name="description" content="Love page for my girl.">
  <style>
    :root{
      --bg:#000;
      --heart:#ff3b7a;
      --halo:#ffa4c2;
      --text:#fff;
      --maxw: 720px;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif
    }
    a{color:#ff8fb1}

    /* ä¸»ç”»å¸ƒåŒºåŸŸ */
    .wrap{
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      position:relative; padding:14px
    }
    canvas{
      display:block; width:min(92vw,var(--maxw));
      height:calc(min(92vw,var(--maxw))*1.12); max-width:var(--maxw);
      border-radius:18px; box-shadow:0 16px 44px rgba(0,0,0,.6); background:var(--bg)
    }
    .overlay-text{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:max(14px, env(safe-area-inset-bottom, 14px));
      width:min(92vw,var(--maxw)); text-align:center; line-height:1.7;
      padding:8px 14px; font-size:clamp(14px,2.7vw,18px);
      text-shadow:0 2px 4px rgba(0,0,0,.6); pointer-events:none
    }
    .overlay-text b{font-weight:700}
    .scroll-down{
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      font-size:13px; opacity:.7; pointer-events:auto
    }

    /* æ‰‹å†™ä¿¡åŒºåŸŸï¼ˆç«–æ’ï¼‰ */
    .letter{
      padding:42px 16px 64px; display:flex; flex-direction:column; align-items:center; gap:12px
    }
    .letter h2{margin:0 0 6px 0; font-size:18px; font-weight:600; opacity:.9}
    .letter .tip{font-size:12px; opacity:.6; margin-bottom:8px}

    /* ç«–å‘ä¸€åˆ—çš„å›¾ç‰‡åˆ—è¡¨ */
    .letter .stack{
      display:flex; flex-direction:column; gap:12px;
      width:min(92vw,var(--maxw)); max-width:var(--maxw);
    }
    .img-wrap{
      display:block; width:100%;
      border-radius:14px; overflow:hidden; box-shadow:0 14px 40px rgba(0,0,0,.65);
      background:#111;
    }
    .img-wrap img{
      width:100%; height:auto; display:block; image-rendering:auto;
    }

    /* è§†é¢‘åŒºï¼ˆDrive é¢„è§ˆ iframeï¼‰ */
    .video-wrap{
      width:min(92vw,var(--maxw)); max-width:var(--maxw);
      aspect-ratio:16/9;
      border-radius:14px; overflow:hidden;
      box-shadow:0 14px 40px rgba(0,0,0,.65);
      background:#111;
    }
    .video-wrap iframe{
      width:100%; height:100%; border:0; display:block;
    }

    .footer{padding:18px 0 48px; text-align:center; font-size:12px; opacity:.45}

    /* ====== éŸ³ä¹å¯åŠ¨é¡µ ====== */
    #gate{
      position:fixed; inset:0; background:#000; color:#fff; z-index:10000;
      display:flex; align-items:center; justify-content:center; padding:20px;
    }
    #gate .card{
      width:min(92vw, 520px); text-align:center; background:#0b0f14;
      border:1px solid #222; border-radius:16px; padding:22px 18px;
      box-shadow:0 20px 60px rgba(0,0,0,.6)
    }
    #gate h1{margin:0 0 8px; font-size:20px}
    #gate p{margin:0 0 16px; opacity:.8; font-size:14px}
    #startBtn{
      padding:12px 20px; border-radius:10px; border:0; cursor:pointer;
      background:#111; color:#fff; font-weight:700; letter-spacing:.3px
    }
    #gate.fade{ animation:fadeOut .38s ease forwards }
    @keyframes fadeOut{ to{ opacity:0; visibility:hidden } }

    /* é¡¶éƒ¨æ’­æ”¾æŒ‰é’® */
    #musicBtn{
      position:fixed; top:12px; right:12px; z-index:5000;
      padding:8px 12px; border-radius:10px; border:0;
      background:#111; color:#fff; opacity:.85; cursor:pointer; font-size:14px;
      display:none;
    }
    #musicBtn:active{ transform:scale(.98) }
  </style>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%92%96%3C/text%3E%3C/svg%3E">
</head>
<body>

<!-- ======== é…ç½®åŒº ======== -->
<script>
  let START_DATE = "2022-12-06";
  let HER_NAME   = "Baby";
  let TIMEZONE   = "Asia/Kuala_Lumpur";

  // ä¸¤å¼ æ‰‹å†™ä¿¡ï¼ˆç«–æ’ï¼‰
  let LETTER_SRCS = ["letter1.jpg", "letter2.jpg"];

  // ä½¿ç”¨ Google Drive é¢„è§ˆåµŒå…¥ï¼ˆå¯æ’­æ”¾ï¼‰ï¼š/file/d/FILE_ID/preview
  // ä½ çš„æ–‡ä»¶ IDï¼š1lDbE7nJ-bqoIBO2hcgcTLezGh9RwIkOy
  let DRIVE_PREVIEW_URL = "https://drive.google.com/file/d/1lDbE7nJ-bqoIBO2hcgcTLezGh9RwIkOy/preview";

  // å¯é€‰ URL è¦†ç›–ï¼š?name=&start=&imgs=imgA.jpg,imgB.jpg&drive=å®Œæ•´previewé“¾æ¥
  const q = new URLSearchParams(location.search);
  if (q.get("name"))  HER_NAME   = q.get("name");
  if (q.get("start")) START_DATE = q.get("start");
  if (q.get("imgs"))  LETTER_SRCS = q.get("imgs").split(",").map(s=>s.trim()).filter(Boolean);
  if (q.get("drive")) DRIVE_PREVIEW_URL = q.get("drive").trim();
</script>

<!-- èƒŒæ™¯éŸ³ä¹ -->
<audio id="bgm" preload="auto" loop playsinline>
  <source src="music.mp3" type="audio/mpeg">
</audio>

<button id="musicBtn">â¸ æš‚åœéŸ³ä¹</button>

<div id="gate">
  <div class="card">
    <h1>å‡†å¤‡å¥½äº†å—ï¼Ÿ</h1>
    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ’­æ”¾éŸ³ä¹å¹¶è¿›å…¥æˆ‘ä»¬çš„ä¸–ç•Œ</p>
    <button id="startBtn">â–¶ï¸ æ’­æ”¾éŸ³ä¹</button>
    <p id="gateTip" style="margin-top:10px; opacity:.6; font-size:12px;"></p>
  </div>
</div>

<!-- çˆ±å¿ƒåŠ¨ç”» -->
<section class="wrap">
  <a class="scroll-down" href="#letter">ğŸ‘‡ å‘ä¸‹çœ‹ä½ çš„æ‰‹å†™ä¿¡</a>
  <canvas id="cv" width="640" height="720"></canvas>
  <div class="overlay-text" id="loveText"></div>
</section>

<!-- æ‰‹å†™ä¿¡åŒºï¼ˆç«–æ’ï¼‰ -->
<section id="letter" class="letter">
  <h2>ç»™ä½ çš„ä¸€å°æ‰‹å†™ä¿¡</h2>
  <div class="tip">ï¼ˆç‚¹å›¾ç‰‡å¯æ”¾å¤§ï¼‰</div>
  <div class="stack" id="letterStack"></div>
</section>

<!-- å›å¿†è§†é¢‘åŒºï¼ˆDrive é¢„è§ˆå¯ç›´æ¥æ’­æ”¾ï¼‰ -->
<section id="video" class="letter" style="padding-top:16px;">
  <h2>æˆ‘ä»¬çš„å›å¿†è§†é¢‘</h2>
  <div class="tip">ï¼ˆç‚¹å‡»æ’­æ”¾ / å…¨å±è§‚çœ‹ï¼‰</div>
  <div class="video-wrap">
    <iframe id="loveVideo" src="" allow="autoplay; encrypted-media" allowfullscreen loading="lazy"></iframe>
  </div>
</section>

<div class="footer">by wenjoo â¤</div>

<script>
/* ======= æ–‡æ¡ˆä¸å±•ç¤º ======= */
function daysTogether(startStr, tz){
  const [y,m,d]=startStr.split("-").map(Number);
  const todayStr=new Intl.DateTimeFormat('sv-SE',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());
  const today=new Date(`${todayStr}T00:00:00`);
  const start=new Date(`${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T00:00:00`);
  return Math.floor((today-start)/86400000)+1;
}
function yearsTogether(startStr,tz){
  const [y,m,d]=startStr.split("-").map(Number);
  const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
  let yrs=now.getFullYear()-y;
  const anniv=new Date(now.getFullYear(),m-1,d);
  if(now<anniv) yrs-=1;
  return Math.max(0,yrs);
}
function renderHeaderText(){
  const d=daysTogether(START_DATE,TIMEZONE);
  const y=yearsTogether(START_DATE,TIMEZONE);
  const todayFmt=new Intl.DateTimeFormat('zh-CN',{timeZone:TIMEZONE,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());
  const line1=`${HER_NAME}ï¼Œçºªå¿µæ—¥å¿«ä¹ï¼`;
  const line2=`ä»Šå¤©æ˜¯æˆ‘ä»¬åœ¨ä¸€èµ·çš„ç¬¬ <b>${d}</b> å¤© â¤ï¸` + (y>0?`ï¼Œä¹Ÿæ˜¯ç¬¬ <b>${y}</b> å‘¨å¹´ ğŸ‰`:"");
  const line3=`â€”â€” ${todayFmt}`;
  document.getElementById("loveText").innerHTML=`${line1}<br>${line2}<br>${line3}`;
}
function renderLetterStack(){
  const stack=document.getElementById('letterStack');
  stack.innerHTML='';
  (LETTER_SRCS||[]).forEach((src,i)=>{
    const a=document.createElement('a');
    a.href=src; a.target='_blank'; a.rel='noopener'; a.className='img-wrap';
    const img=document.createElement('img');
    img.loading='lazy'; img.decoding='async'; img.alt=`æ‰‹å†™ä¿¡${i+1}`; img.src=src;
    a.appendChild(img); stack.appendChild(a);
  });
  if(!LETTER_SRCS||LETTER_SRCS.length===0) document.getElementById('letter').style.display='none';
}
function renderVideo(){
  const iframe=document.getElementById('loveVideo');
  if(!DRIVE_PREVIEW_URL){ document.getElementById('video').style.display='none'; return; }
  // ä½¿ç”¨ Drive /preview å¯åœ¨ iframe å†…ç›´æ¥æ’­æ”¾
  iframe.src = DRIVE_PREVIEW_URL;
}
function renderAll(){ renderHeaderText(); renderLetterStack(); renderVideo(); }
renderAll();

/* ======= çˆ±å¿ƒåŠ¨ç”» ======= */
const BG="#000";
const HEART=getComputedStyle(document.documentElement).getPropertyValue('--heart').trim()||"#ff3b7a";
const HALO=getComputedStyle(document.documentElement).getPropertyValue('--halo').trim()||"#ffa4c2";
const FPS=30;
const QUALITY=window.matchMedia('(max-width: 480px)').matches?0.65:0.85;
function heartXY(t,shrink=10){let x=16*Math.sin(t)**2*Math.sin(t);let y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);x/=16;y/=18;return [x/shrink,-y/shrink];}
const rand=(a,b)=>a+Math.random()*(b-a),choice=a=>a[(Math.random()*a.length)|0],clamp01=x=>Math.min(1,Math.max(0,x));
function shrink(x,y,r){return [x*r,y*r]}function scatterInside(x,y,b=0.07){const r=-b*Math.log(Math.random()+1e-9);return [x-r*(x-0),y-r*(y-0)]}
function ease01(x){return (1-Math.cos(clamp01(x)*Math.PI))/2}function S(n){return Math.max(1,Math.round(n*QUALITY))}
function genFrame(frame,total){
  const ratio=0.2+9.8*ease01(frame/total);const pts=[];
  const haloN=S(1200+800*Math.abs(ease01(frame/total)**2));
  for(let i=0;i<haloN;i++){const t=rand(0,Math.PI*2);let [x,y]=heartXY(t,11.0);[x,y]=shrink(x,y,ratio/11.0);pts.push({x,y,s:Math.random()<0.5?1:2,h:true});}
  const edge=[];for(let i=0;i<S(250);i++){const t=rand(0,Math.PI*2);edge.push(heartXY(t,1.0));}
  for(const [ex,ey] of edge){let [x,y]=scatterInside(ex,ey,0.05);pts.push({x:x/ratio,y:y/ratio,s:1+(Math.random()*2|0),h:false});}
  for(let i=0;i<S(2000);i++){const [ex,ey]=choice(edge);let [x,y]=scatterInside(ex,ey,0.17);pts.push({x:x/ratio,y:y/ratio,s:1+(Math.random()*2|0),h:false});}
  return pts;
}
(function startHeart(){
  const cv=document.getElementById("cv"),ctx=cv.getContext("2d");
  const W=cv.width,H=cv.height;let frame=0;const total=6*FPS;
  function draw(){
    ctx.fillStyle=BG;ctx.fillRect(0,0,W,H);
    const ps=genFrame(frame,total),cx=W/2,cy=H/2-30,scale=W*0.85;
    for(let i=0;i<ps.length;i++){const p=ps[i],X=(cx+p.x*scale)|0,Y=(cy+p.y*scale)|0;ctx.fillStyle=p.h?HALO:HEART;ctx.fillRect(X,Y,p.s,p.s);}
    frame=(frame+1)%total;
  }
  let last=0,acc=0,interval=1000/FPS;
  function loop(ts){if(!last)last=ts;const d=ts-last;last=ts;acc+=d;while(acc>=interval){draw();acc-=interval;}requestAnimationFrame(loop);}
  requestAnimationFrame(loop);
})();

/* ======= éŸ³ä¹æ§åˆ¶ ======= */
(function musicGate(){
  const audio=document.getElementById('bgm');
  const gate=document.getElementById('gate');
  const btn=document.getElementById('startBtn');
  const tip=document.getElementById('gateTip');
  const toggle=document.getElementById('musicBtn');
  let isPlaying=false;

  audio.addEventListener('canplay',()=>{tip.textContent='å·²å‡†å¤‡å¥½ï¼Œç‚¹å‡»æ’­æ”¾éŸ³ä¹';});
  audio.addEventListener('error',()=>{tip.textContent='éŸ³é¢‘åŠ è½½å¤±è´¥ï¼šè¯·æ£€æŸ¥ music.mp3 è·¯å¾„';});

  function fadeTo(target=1,ms=800){
    const steps=16,dt=ms/steps;let v=audio.volume||0,dv=(target-v)/steps;
    const id=setInterval(()=>{
      v+=dv;
      if((dv>0&&v>=target)||(dv<0&&v<=target)){v=target;clearInterval(id);}
      audio.volume=Math.max(0,Math.min(1,v));
    },dt);
  }

  async function start(){
    try{
      btn.disabled=true;
      tip.textContent='åŠ è½½ä¸­â€¦';
      audio.muted=false;
      audio.currentTime=0;
      audio.volume=0;
      await audio.play();
      fadeTo(1,800);
      isPlaying=true;
      toggle.style.display='inline-block';
      toggle.textContent='â¸ æš‚åœéŸ³ä¹';
      gate.classList.add('fade');
      setTimeout(()=>{gate.style.display='none';},400);
    }catch(e){
      btn.disabled=false;
      tip.textContent='æœªèƒ½æ’­æ”¾ï¼šè¯·å†ç‚¹ä¸€æ¬¡æˆ–æ£€æŸ¥æ–‡ä»¶';
      console.log('play error:',e);
    }
  }

  btn.addEventListener('click',start);
  toggle.addEventListener('click',()=>{
    if(!isPlaying){start();return;}
    if(audio.paused){audio.play().catch(()=>{});toggle.textContent='â¸ æš‚åœéŸ³ä¹';}
    else{audio.pause();toggle.textContent='â™ª æ’­æ”¾éŸ³ä¹';}
  });

  const kick=()=>{if(!isPlaying){start();}window.removeEventListener('touchstart',kick);window.removeEventListener('keydown',kick);};
  window.addEventListener('touchstart',kick,{once:true});
  window.addEventListener('keydown',kick,{once:true});
})();
</script>
</body>
</html>
